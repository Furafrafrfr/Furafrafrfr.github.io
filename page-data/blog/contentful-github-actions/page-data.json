{"componentChunkName":"component---src-templates-blog-template-tsx","path":"/blog/contentful-github-actions","result":{"data":{"markdownRemark":{"frontmatter":{"category":["Gatsby.js","Contentful","GitHub Actions"],"title":"ContentfulでEntryが公開されたらGitHub Actionsであれこれする","slug":"/blog/contentful-github-actions","date":"2021-11-23"},"html":"<p>Contentfulのspace内で何かしらイベントが発生した際にWebhookを送ることができるのを利用してGitHub ActionsでGatsby.js製のサイトをビルドするようにしたのでメモ。主にContentfulでのWebhook送信とGitHub Actionsの設定について書きます。</p>\n<h2>やること</h2>\n<h3>GitHub側</h3>\n<h4>1. リポジトリのワークフローファイルの編集</h4>\n<p>ワークフローをトリガーするイベントにworkflow_dispatchを追加するだけです。\n例:</p>\n<div class=\"gatsby-highlight\" data-language=\"yml\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-yml line-numbers\"><code class=\"language-yml\"><span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> deploy on github pages\n\n<span class=\"token key atrule\">on</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">push</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">branches</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> main\n  workflow_dispatch<span class=\"token punctuation\">:</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h4>2. Personal access tokensの取得</h4>\n<p><a href=\"https://docs.github.com/ja/authentication/keeping-your-account-and-data-secure/creating-a-personal-access-token\">個人アクセストークンを使用する - GitHub Docs</a>を参照。アクセストークンは作成後のみ表示されコピーできるのでそのうちに控えておきましょう。Contentful側の設定で使います。その後ページを閉じたりリロードした場合は再度確認することができないようなので注意。わからなくなった場合は作り直す必要があります。</p>\n<h3>Contentful側</h3>\n<h4>1. spaceでのWebhookの設定</h4>\n<p>spaceのSettings > Webhooksを開く。\n<span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 650px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/b5a8c03ff54970dc38a23665c111a7ee/0f7d5/webhook.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 64.41717791411043%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAIAAAAmMtkJAAAACXBIWXMAAA7DAAAOwwHHb6hkAAAB8ElEQVQoz22R205TQRSG94N4ozEGhNSE2Kr1FLxBqIlGX0Lfw4fRJ1AeANToDRhoC20R2m7aMvs0xzVrTqZ7x0aFyZc/62L+Wfn/ia7dalxfeXhj9dHy2vrN2uNas7X25GXtQWv1/mat+eJOs3X36avl+kat2VqqbzSevamvv165t3W7sblUfx7tHhztHBztLjg8/nLYW/C1XWqn/607+NH91ekPu73To8Gw2ztrD+KI2ECsLzX8mf+hE0+/H5/sn45OSK4RvfehPOhDNOLqMmdMVvSToj0hnWmyP4wPR1PKpbW2Mkt00VjAZYjCFDABTLXJ0ORoidIzDkICIioFwXtlwhXmWIA21hnrnXPWGkRXbkPrc8YLSrmQV5tHAs6lLriIJ7M0K2YkmV2QNMuNQaENl8o568rYXPurNksNIDVPjcg1z5M0I0k6uyBJziiXjDHQWGYO0ZjDnMVmDjPQvan4tEe2f6Y73ayg89torbKBcqG1rgpTxkdjpv9myCDT+nNbvf2QvfuYvd+eO1mWQV4gmIIJKZUpKwDj/jdXoHUh+BC89167AExAbyD2DnLGuRDVV88LixleNhOhEwGJAFJqInWOLtWecqXROOfLzD46p6Yiplg+hBNupALGKGWsKArOGC2od9Y6z8GC8RUK/W8e+rDryqKilgAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"where is webhook\"\n        title=\"where is webhook\"\n        src=\"/static/b5a8c03ff54970dc38a23665c111a7ee/a6d36/webhook.png\"\n        srcset=\"/static/b5a8c03ff54970dc38a23665c111a7ee/222b7/webhook.png 163w,\n/static/b5a8c03ff54970dc38a23665c111a7ee/ff46a/webhook.png 325w,\n/static/b5a8c03ff54970dc38a23665c111a7ee/a6d36/webhook.png 650w,\n/static/b5a8c03ff54970dc38a23665c111a7ee/e548f/webhook.png 975w,\n/static/b5a8c03ff54970dc38a23665c111a7ee/0f7d5/webhook.png 993w\"\n        sizes=\"(max-width: 650px) 100vw, 650px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span>\nその後右上のAdd Webhookを選択するとこんな感じのページが表示されます。\n<span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 650px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/e30b07e077341b5f78b772d0166c86d1/29114/setting.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 50.920245398773%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAAAsTAAALEwEAmpwYAAABSElEQVQoz42Sa04CMRSFuzaX4A8TREQQIkiiCRhwi27AFRCjjsyj09dtO3NMO4KgoDT5Mmk7Offc28Mub2Y4bQ1w1p2gd7tAb7zA1Xge6U8e0R3N0b6+R6t/h/Zg+ouL4RSd4Qyd0QNOWudgigyk1lDawFcVauAg+5axDoY8BBk8LZ/BiAjWunhZ1/WfVNtUVSyTlxrLpETKNbwDmLU2Cq5/Cvhj8FUsUpQCL28fSNICpdJgQhmUQkZR5xy8999u/3EdFhcSySpFVpSQ2oCF+eUFh5QKhgjG0K5ovX966/OcCyxfE6yyAlwoMOs8DIW2m9atC059M7PwjbPCjnC9tefS4D0TWOUchZBghhyU8Xsd1Ec8FDkHY218bU0WTJNDWlpYfygY+DMBQUgZ2sCU1shyDiGbLMa2tyBrm3z+iM1XlY1gcBccfgIBz/A7HqE5DQAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"webhook settings\"\n        title=\"webhook settings\"\n        src=\"/static/e30b07e077341b5f78b772d0166c86d1/a6d36/setting.png\"\n        srcset=\"/static/e30b07e077341b5f78b772d0166c86d1/222b7/setting.png 163w,\n/static/e30b07e077341b5f78b772d0166c86d1/ff46a/setting.png 325w,\n/static/e30b07e077341b5f78b772d0166c86d1/a6d36/setting.png 650w,\n/static/e30b07e077341b5f78b772d0166c86d1/e548f/setting.png 975w,\n/static/e30b07e077341b5f78b772d0166c86d1/3c492/setting.png 1300w,\n/static/e30b07e077341b5f78b772d0166c86d1/29114/setting.png 1920w\"\n        sizes=\"(max-width: 650px) 100vw, 650px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<h5>Name</h5>\n<p>Contentful上での名前です。何でも大丈夫です。</p>\n<h5>URL</h5>\n<p>Webhookの送信先です。今回はGitHub Actionsでworkflow_dispatchイベントをトリガーさせるには以下のURLを使います。</p>\n<div class=\"gatsby-highlight\" data-language=\"url\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-url line-numbers\"><code class=\"language-url\"><span class=\"token scheme\">https<span class=\"token scheme-delimiter\">:</span></span><span class=\"token authority\"><span class=\"token authority-delimiter\">//</span><span class=\"token host\">https</span><span class=\"token port-segment\"><span class=\"token port-delimiter\">:</span></span></span><span class=\"token authority\"><span class=\"token authority-delimiter\">//</span><span class=\"token host\">api.github.com</span></span><span class=\"token path\"><span class=\"token path-separator\">/</span>repos<span class=\"token path-separator\">/</span></span>{owner}/{repo}/actions/workflows/{workflow_id}/dispatches</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span></span></pre></div>\n<p>(<a href=\"https://docs.github.com/ja/rest/reference/actions#create-a-workflow-dispatch-event\">アクション - GitHub Docs</a>)</p>\n<h5>owner</h5>\n<p>リポジトリを所有しているアカウントの名前</p>\n<h5>repo</h5>\n<p>リポジトリの名前</p>\n<h5>workflow_id</h5>\n<p>workflowのIDということになっているがどこで確認できるのかわからなかった。ワークフローのファイル名でもいいということなのでそちらを使いました。</p>\n<h5>Triggers</h5>\n<p>どんなイベントでWebhookを送信するかを指定します。最初のラジオボタンは<code>Select specific triggering events</code>の方を選択します。Entryの公開/非公開で発火させる場合はこんな感じに設定します。\n<span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 650px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/5649c0756446362b95169aa76748c3de/29114/content-event-setting.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 50.920245398773%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAAAsTAAALEwEAmpwYAAABZElEQVQoz4VSYUvDMBTsXxQ/CHO4OZ1uKAqKm39XGOKsbdc0bfLykp68dK3DCRau1768XO9dmlzcPuN0NMfZ5B6TxQumyxUul2tMl2vM7l4xWawwvnrEaPaA8+unI4znHWTvyfQGSUMWRalQ6RplpUHOI7TtHwBaAfaQGxD7jXWorcHbbovEOY5ixlo0hqAbB+ccyP0wUc8UawJLhLYNKLXBJq2QKwMij8QxwxiLVlyEAGaG9z17sIB9fDbOw7FHQxzr4lymet9+Ic1LaGM7h9ZSFBQh2cD+GIdrkbkTVLpGmuUoygq1CPauwuDwb8HfEFGJcac0Nh8psqKE0g0SyUVVFerG7vPj+IH/IH1yqdris9DIdgqlrpGIIwmY40ghjuZDGNxG9n54l/V+KomJmGHlkBzDkEMi+WV5ERflhxDuMQgNLGLtUJMeEWosDYgZykmLqx5SOzqEA+6eOfbRXlDcicNva/vuNPag8HwAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"content event settings\"\n        title=\"content event settings\"\n        src=\"/static/5649c0756446362b95169aa76748c3de/a6d36/content-event-setting.png\"\n        srcset=\"/static/5649c0756446362b95169aa76748c3de/222b7/content-event-setting.png 163w,\n/static/5649c0756446362b95169aa76748c3de/ff46a/content-event-setting.png 325w,\n/static/5649c0756446362b95169aa76748c3de/a6d36/content-event-setting.png 650w,\n/static/5649c0756446362b95169aa76748c3de/e548f/content-event-setting.png 975w,\n/static/5649c0756446362b95169aa76748c3de/3c492/content-event-setting.png 1300w,\n/static/5649c0756446362b95169aa76748c3de/29114/content-event-setting.png 1920w\"\n        sizes=\"(max-width: 650px) 100vw, 650px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span>\nその下のFiltersの設定は必要であれば設定してください。これは特定のContent typeやEntryの場合に発火するように設定できるようです。</p>\n<h5>Headers</h5>\n<p>AcceptとAuthorizationとUser-Agentを設定します。(<a href=\"https://docs.github.com/ja/rest/overview/resources-in-the-rest-api\">REST API のリソース - GitHub Docs</a>)\nAcceptヘッダには<code>application/vnd.github.v3+json</code>を設定します。注意が必要なのはAuthorizationヘッダですが、アクセストークンが漏れるとまずいので画像の<code>Add secret header</code>から追加しましょう。これに<code>token {取得したPersonal access token}</code>を設定します。\n<span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 650px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 23.31288343558282%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAFCAYAAABFA8wzAAAACXBIWXMAAB2HAAAdhwGP5fFlAAAAiklEQVQY062Puw7CMBAE/f9fiSjoIIntxI7vMcimggQqVppmbzXShWlecPefnOWw6x0Qlpgwd8y+4E5etzdKqeOmZpgZao7EjJVKmGMi5ZW9Nep+QhPyWkh5G3Rh74dIbUg7bY7oVgiPVJhSIVehiR4QVURetNY3MmSfL1vd8SaE66Rc7sptUf6RJ4NDidxiglKZAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Header settings\"\n        title=\"Header settings\"\n        src=\"/static/4fcfbc66d73e59097029e0fe0633657b/a6d36/header.png\"\n        srcset=\"/static/4fcfbc66d73e59097029e0fe0633657b/222b7/header.png 163w,\n/static/4fcfbc66d73e59097029e0fe0633657b/ff46a/header.png 325w,\n/static/4fcfbc66d73e59097029e0fe0633657b/a6d36/header.png 650w,\n/static/4fcfbc66d73e59097029e0fe0633657b/e548f/header.png 975w,\n/static/4fcfbc66d73e59097029e0fe0633657b/3c492/header.png 1300w,\n/static/4fcfbc66d73e59097029e0fe0633657b/191e2/header.png 1836w\"\n        sizes=\"(max-width: 650px) 100vw, 650px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<p>上の画像には写ってませんがUser-Agentの設定も必要です。これなんと私がこの記事書いてよしPublishや！！と思ってPublishしたら動かなかったので確認したらこれも必要だったということらしいです。ユーザー名またはアプリケーション名しようしてくださいとのことなのでGitHubのユーザー名に設定します。</p>\n<h5>Payload</h5>\n<p>bodyの設定です。。<a href=\"https://docs.github.com/ja/rest/reference/actions#create-a-workflow-dispatch-event\">アクション - GitHub Docs</a>を参考にしましょう。JSON形式で記述します。</p>\n<p>これでContentful側の設定も終わりです。</p>\n<p>一応ワークフローファイル全体も参考までに上げておきます。本当はキャッシュとか効かせるように設定するといいのかな？</p>\n<div class=\"gatsby-highlight\" data-language=\"yml\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-yml line-numbers\"><code class=\"language-yml\"><span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> deploy on github pages\n\n<span class=\"token key atrule\">on</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">push</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">branches</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> main\n  <span class=\"token key atrule\">workflow_dispatch</span><span class=\"token punctuation\">:</span>\n\n<span class=\"token key atrule\">jobs</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">deploy</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Deploy on Github Pages\n    <span class=\"token key atrule\">runs-on</span><span class=\"token punctuation\">:</span> ubuntu<span class=\"token punctuation\">-</span>latest\n    <span class=\"token key atrule\">env</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">CONTENTFUL_HOST</span><span class=\"token punctuation\">:</span> cdn.contentful.com\n      <span class=\"token key atrule\">CONTENTFUL_ACCESS_TOKEN</span><span class=\"token punctuation\">:</span> $<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> secrets.CONTENTFUL_ACCESS_TOKEN <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n      <span class=\"token key atrule\">CONTENTFUL_SPACE_ID</span><span class=\"token punctuation\">:</span> $<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> secrets.CONTENTFUL_SPACE_ID <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n      <span class=\"token key atrule\">GOOGLE_ANALYTICS_GTAG</span><span class=\"token punctuation\">:</span> $<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> secrets.GOOGLE_ANALYTICS_GTAG <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n\n    <span class=\"token key atrule\">steps</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">uses</span><span class=\"token punctuation\">:</span> actions/checkout@v2\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">uses</span><span class=\"token punctuation\">:</span> actions/setup<span class=\"token punctuation\">-</span>node@v2\n        <span class=\"token key atrule\">with</span><span class=\"token punctuation\">:</span>\n          <span class=\"token key atrule\">node-version</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"16.9.1\"</span>\n\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Install packages\n        <span class=\"token key atrule\">run</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">|</span><span class=\"token scalar string\">\n          npm i -g gatsby-cli@3.0.0 yarn@1.22.10\n          yarn install</span>\n\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Build\n        <span class=\"token key atrule\">run</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"gatsby build\"</span>\n\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Deploy on Github Pages\n        <span class=\"token key atrule\">uses</span><span class=\"token punctuation\">:</span> peaceiris/actions<span class=\"token punctuation\">-</span>gh<span class=\"token punctuation\">-</span>pages@v3\n        <span class=\"token key atrule\">with</span><span class=\"token punctuation\">:</span>\n          <span class=\"token key atrule\">github_token</span><span class=\"token punctuation\">:</span> $<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> secrets.GITHUB_TOKEN <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n          <span class=\"token key atrule\">deploy_key</span><span class=\"token punctuation\">:</span> $<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span>secrets.ACTIONS_DEPLOY_KEY<span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n          <span class=\"token key atrule\">external_repository</span><span class=\"token punctuation\">:</span> Furafrafrfr/Furafrafrfr.github.io\n          <span class=\"token key atrule\">publish_branch</span><span class=\"token punctuation\">:</span> main\n          <span class=\"token key atrule\">publish_dir</span><span class=\"token punctuation\">:</span> ./public</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h2>終わりに</h2>\n<p>GitHub Actionsすごい</p>"}},"pageContext":{"slug":"/blog/contentful-github-actions"}},"staticQueryHashes":["2530755699","3037963316","3200490486"]}