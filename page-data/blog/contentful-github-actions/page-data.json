{
    "componentChunkName": "component---src-templates-blog-template-js",
    "path": "/blog/contentful-github-actions",
    "result": {"data":{"site":{"siteMetadata":{"siteUrl":"https://furafrafrfr.github.io"}},"contentfulBlogPostV2":{"content":{"childMarkdownRemark":{"frontmatter":{"category":["Gatsby.js","Contentful","GitHub Actions"],"date":"2021-11-23","slug":"/blog/contentful-github-actions","title":"ContentfulでEntryが公開されたらGitHub Actionsであれこれする"},"html":"<p>Contentfulのspace内で何かしらイベントが発生した際にWebhookを送ることができるのを利用してGitHub ActionsでGatsby.js製のサイトをビルドするようにしたのでメモ。主にContentfulでのWebhook送信とGitHub Actionsの設定について書きます。</p>\n<h2>やること</h2>\n<h3>GitHub側</h3>\n<h4>1. リポジトリのワークフローファイルの編集</h4>\n<p>ワークフローをトリガーするイベントにworkflow_dispatchを追加するだけです。\n例:</p>\n<div class=\"gatsby-highlight\" data-language=\"yml\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-yml line-numbers\"><code class=\"language-yml\"><span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> deploy on github pages\n\n<span class=\"token key atrule\">on</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">push</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">branches</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> main\n  workflow_dispatch<span class=\"token punctuation\">:</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h4>2. Personal access tokensの取得</h4>\n<p><a href=\"https://docs.github.com/ja/authentication/keeping-your-account-and-data-secure/creating-a-personal-access-token\">個人アクセストークンを使用する - GitHub Docs</a>を参照。アクセストークンは作成後のみ表示されコピーできるのでそのうちに控えておきましょう。Contentful側の設定で使います。その後ページを閉じたりリロードした場合は再度確認することができないようなので注意。わからなくなった場合は作り直す必要があります。</p>\n<h3>Contentful側</h3>\n<h4>1. spaceでのWebhookの設定</h4>\n<p>spaceのSettings > Webhooksを開く。\n<img src=\"//images.contentful.com/mnw1ncy9zg2f/2sP9uE7u7tb9zIfl0DO6Vr/943c2d98b387c6b129227fcade035b83/______.png\" alt=\"where is webhook\">\nその後右上のAdd Webhookを選択するとこんな感じのページが表示されます。\n<img src=\"//images.contentful.com/mnw1ncy9zg2f/31cwa3aMnqavElfX97uRRG/07fd04f18a2350f5bd72a29c326934fe/app.contentful.com_spaces_mnw1ncy9zg2f_settings_webhooks_4jXDOkGqbKjIl5ynyKbq6V.png\" alt=\"webhook settings\"></p>\n<ul>\n<li>Name</li>\n</ul>\n<p>Contentful上での名前です。何でも大丈夫です。</p>\n<ul>\n<li>URL</li>\n</ul>\n<p>どこにWebhookを送信するのかです。今回はGitHub Actionsでworkflow_dispatchイベントをトリガーさせたいので<code>https://https://api.github.com/repos/{owner}/{repo}/actions/workflows/{workflow_id}/dispatches</code>を指定します。(<a href=\"https://docs.github.com/ja/rest/reference/actions#create-a-workflow-dispatch-event\">アクション - GitHub Docs</a>)</p>\n<ul>\n<li>owner</li>\n</ul>\n<p>リポジトリを所有しているアカウントの名前</p>\n<ul>\n<li>repo</li>\n</ul>\n<p>リポジトリの名前</p>\n<ul>\n<li>workflow_id</li>\n</ul>\n<p>workflowのIDということになっているがどこで確認できるのかわからなかった。ワークフローのファイル名でもいいということなのでそちらを使いました。</p>\n<ul>\n<li>Triggers</li>\n</ul>\n<p>どんなイベントでWebhookを送信するかを指定します。最初のラジオボタンは<code>Select specific triggering events</code>の方を選択します。Entryの公開/非公開で発火させる場合はこんな感じに設定します。\n<a\n          class=\"gatsby-resp-image-link\"\n          href=\"https://images.ctfassets.net/mnw1ncy9zg2f/5kGlWrSQCKiujUDlWxdBwX/fc3da4f0a21a809800182d1e28abf6a1/app.contentful.com_spaces_mnw1ncy9zg2f_settings_webhooks_4jXDOkGqbKjIl5ynyKbq6V__3_.png\"\n          style=\"display: block\"\n          target=\"_blank\"\n          rel=\"noopener\"\n        >\n          <span\n        class=\"gatsby-resp-image-wrapper\"\n        style=\"position: relative; display: block; margin:1rem auto;; max-width: 600px; margin-left: auto; margin-right: auto;\"\n      >\n        <span\n          class=\"gatsby-resp-image-background-image\"\n          style=\"padding-bottom: 50.88541666666667%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAUCAMAAADImI+JAAABzlBMVEUqN0okLDsUHi0RGysXITAdKDooM0UpNEYjL0EnM0UoNEYiLT8nMkUlMEIqNUciLkAmMkQbJjciKzocJjUYIzYbJzogKz4zO0kaIzKVm6OOlpyUmaCTmaCXnaaYnqeWnKSWnaV2i4mEkZT1+Pnn8u7p6+zi5Obk5+ni5efh5Obt7/H3+fr2+Pnt7vD09ve53MrV6d/////29vb09fX29/f6+/zs7vHt7/Lx9Pb2+Prv8PHt7e7t7u/s7u/n7fXo7fXt8fb29/j39/j29vf19vf19fb19vb4+Pj7+/vj6/Xi6/fs8vnt8/n09/r9/f38/f35+fr+/v76+vv4+Pn4+fn6+vr8/Pz9/f7q7fHq7vLo7PLp7PHx9fj1+Pr3+Pnw8fL9/v74+fr+/v/8/P35+vv2+Pj+///s7/Ht8PHt8PLy9fb7/Pz5+/7p8vzl8Pvn6ezl6Orn6uzu8fL7/P3p7O7r7u/w8/Tx8/T09vj6+/vs7vDw8vTr7vDu8PP19/n19fXh5uri5urk6Ozr7e/3+Pj39/fl6vHk6vHk6vLm6+/o6+3y9vrx9v3v9Pz7+/z09fb19ffz9PXp6uv5+/v4+vv19/jr7Ozu7u/x8vL4+vq5BBnkAAAACXBIWXMAABcRAAAXEQHKJvM/AAAAB3RJTUUH5QwXDiEBc2WqyQAAAdRJREFUKM+FkYlX00AQxiMqiAeK91ERFFDaiC7sqq2KdhOCgG46tRjwgLRgW1wviOANiBXl8hbtf+ukaSX4HvDNfLszL79sNruKsqFs46bN5RVbKrdu276jqmLnrurde/buW6H9VQcOKocOHwkEjtb4dCwQqK35T3XHlRP1DY0nTzU1BkOrSFXV081nziqkpZWSNcTOnb+AbFghkYuXIpcjbVeu0iillGtRXae03TC40dGuXyOss6ur+/qNkEKEME1hihjEQdwESAjoicOtGDYCOizCevtu37l7D8H+gVbbtiAJMYBoCmdIDoIYAriPFaRZMJPJDj/AT/dTcMUwiikBHj4CeOw2afbk6cjIaAhXTLj/AkTicyIJYDoAtuk1CD4bG38+/gJBdeClZZlOWKrSUR3pppQsVGjCMs1Gg8Ovsq8RtApyGMZyylJF2Ju3mYnC8Uy2TK55jlPvpt9nx3BFzg2q6ZwaNMo1mqOalvjAtRwG16kgbObjp9m5uWYXpNr8wqK92orFm1TIZ9yR4wpHC76ADdx1HIevg7YP/PY99+91ID/QQ+ifxCvSy+Cvpd9iJejZK3xg7k88VRKkJJoVZq/wgdKnfH4inyzaK3x7XEcl8C9uQdVgHkyz4AAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n        >\n          <picture>\n          <source\n            srcset=\"https://images.ctfassets.net/mnw1ncy9zg2f/5kGlWrSQCKiujUDlWxdBwX/fc3da4f0a21a809800182d1e28abf6a1/app.contentful.com_spaces_mnw1ncy9zg2f_settings_webhooks_4jXDOkGqbKjIl5ynyKbq6V__3_.png?w=480&fm=webp 480w,\nhttps://images.ctfassets.net/mnw1ncy9zg2f/5kGlWrSQCKiujUDlWxdBwX/fc3da4f0a21a809800182d1e28abf6a1/app.contentful.com_spaces_mnw1ncy9zg2f_settings_webhooks_4jXDOkGqbKjIl5ynyKbq6V__3_.png?w=960&fm=webp 960w,\nhttps://images.ctfassets.net/mnw1ncy9zg2f/5kGlWrSQCKiujUDlWxdBwX/fc3da4f0a21a809800182d1e28abf6a1/app.contentful.com_spaces_mnw1ncy9zg2f_settings_webhooks_4jXDOkGqbKjIl5ynyKbq6V__3_.png?w=1920&fm=webp 1920w\"\n            sizes=\"(max-width: 600px) 100vw, 600px\"\n            type=\"image/webp\"\n          />\n          <source\n            srcset=\"https://images.ctfassets.net/mnw1ncy9zg2f/5kGlWrSQCKiujUDlWxdBwX/fc3da4f0a21a809800182d1e28abf6a1/app.contentful.com_spaces_mnw1ncy9zg2f_settings_webhooks_4jXDOkGqbKjIl5ynyKbq6V__3_.png?w=480 480w,\nhttps://images.ctfassets.net/mnw1ncy9zg2f/5kGlWrSQCKiujUDlWxdBwX/fc3da4f0a21a809800182d1e28abf6a1/app.contentful.com_spaces_mnw1ncy9zg2f_settings_webhooks_4jXDOkGqbKjIl5ynyKbq6V__3_.png?w=960 960w,\nhttps://images.ctfassets.net/mnw1ncy9zg2f/5kGlWrSQCKiujUDlWxdBwX/fc3da4f0a21a809800182d1e28abf6a1/app.contentful.com_spaces_mnw1ncy9zg2f_settings_webhooks_4jXDOkGqbKjIl5ynyKbq6V__3_.png?w=1920 1920w\"\n            sizes=\"(max-width: 600px) 100vw, 600px\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            style=\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;\"\n            alt=\"content event settings\"\n            title=\"\"\n            src=\"https://images.ctfassets.net/mnw1ncy9zg2f/5kGlWrSQCKiujUDlWxdBwX/fc3da4f0a21a809800182d1e28abf6a1/app.contentful.com_spaces_mnw1ncy9zg2f_settings_webhooks_4jXDOkGqbKjIl5ynyKbq6V__3_.png\"\n            loading=\"lazy\"\n          />\n        </picture>\n        </span>\n      </span>\n        </a>\nその下のFiltersの設定は必要であれば設定してください。これは特定のContent typeやEntryの場合に発火するように設定できるようです。</p>\n<ul>\n<li>Headers</li>\n</ul>\n<p>AcceptとAuthorizationとUser-Agentを設定します。(<a href=\"https://docs.github.com/ja/rest/overview/resources-in-the-rest-api#conditional-requests\">REST API のリソース - GitHub Docs</a>)\nAcceptヘッダには<code>application/vnd.github.v3+json</code>を設定します。注意が必要なのはAuthorizationヘッダですが、アクセストークンが漏れるとまずいので画像の<code>Add secret header</code>から追加しましょう。これに<code>token {取得したPersonal access token}</code>を設定します。\n<a\n          class=\"gatsby-resp-image-link\"\n          href=\"https://images.ctfassets.net/mnw1ncy9zg2f/1ZwcZ8IMhGzDOdE1X8SFDl/eb71cf65c0b4133d3a2adb86582a88ea/____________________________2021-11-23_222628.png\"\n          style=\"display: block\"\n          target=\"_blank\"\n          rel=\"noopener\"\n        >\n          <span\n        class=\"gatsby-resp-image-wrapper\"\n        style=\"position: relative; display: block; margin:1rem auto;; max-width: 600px; margin-left: auto; margin-right: auto;\"\n      >\n        <span\n          class=\"gatsby-resp-image-background-image\"\n          style=\"padding-bottom: 23.52941176470588%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAJCAMAAAB30J7MAAAAnFBMVEX////+/v/j5ObZ293g4uT+/v79/v79/f38/f39/f7v8PLq6+329/jm5+rs7e/t7vDs7vDo6uzw8fPr7e/57/L33+T34eb7/P32+Pn3+fr6+/z6/Pzm6ezk5+rj5uro6+73+Pnt7vHz9Pbu7/Lw8fT09ff4+fr+///5/P7h7vzj7/zc6/vk7/zb6vvm8fzf7fvg7fzd7PvY6fv3+v7lTgF4AAAACXBIWXMAAB2HAAAdhwGP5fFlAAAAB3RJTUUH5QwXDiEABGKaXwAAAG5JREFUGBmNwTEKwkAUQMH3zBKwsVqws9X7H8XOHCEQ0ELFgH5jRMhaGGf4lyPmSS0lCUrRQ6LSM1PLypdH5eXKKGsraykpX7obJJKDnonawT11ueEtr2xlezyFYfARkShtDiA7R3t+S1AbC2XGEznzGRBTFzx1AAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n        >\n          <picture>\n          <source\n            srcset=\"https://images.ctfassets.net/mnw1ncy9zg2f/1ZwcZ8IMhGzDOdE1X8SFDl/eb71cf65c0b4133d3a2adb86582a88ea/____________________________2021-11-23_222628.png?w=459&fm=webp 459w,\nhttps://images.ctfassets.net/mnw1ncy9zg2f/1ZwcZ8IMhGzDOdE1X8SFDl/eb71cf65c0b4133d3a2adb86582a88ea/____________________________2021-11-23_222628.png?w=918&fm=webp 918w,\nhttps://images.ctfassets.net/mnw1ncy9zg2f/1ZwcZ8IMhGzDOdE1X8SFDl/eb71cf65c0b4133d3a2adb86582a88ea/____________________________2021-11-23_222628.png?w=1836&fm=webp 1836w\"\n            sizes=\"(max-width: 600px) 100vw, 600px\"\n            type=\"image/webp\"\n          />\n          <source\n            srcset=\"https://images.ctfassets.net/mnw1ncy9zg2f/1ZwcZ8IMhGzDOdE1X8SFDl/eb71cf65c0b4133d3a2adb86582a88ea/____________________________2021-11-23_222628.png?w=459 459w,\nhttps://images.ctfassets.net/mnw1ncy9zg2f/1ZwcZ8IMhGzDOdE1X8SFDl/eb71cf65c0b4133d3a2adb86582a88ea/____________________________2021-11-23_222628.png?w=918 918w,\nhttps://images.ctfassets.net/mnw1ncy9zg2f/1ZwcZ8IMhGzDOdE1X8SFDl/eb71cf65c0b4133d3a2adb86582a88ea/____________________________2021-11-23_222628.png?w=1836 1836w\"\n            sizes=\"(max-width: 600px) 100vw, 600px\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            style=\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;\"\n            alt=\"Header settings\"\n            title=\"\"\n            src=\"https://images.ctfassets.net/mnw1ncy9zg2f/1ZwcZ8IMhGzDOdE1X8SFDl/eb71cf65c0b4133d3a2adb86582a88ea/____________________________2021-11-23_222628.png\"\n            loading=\"lazy\"\n          />\n        </picture>\n        </span>\n      </span>\n        </a></p>\n<p>上の画像には写ってませんがUser-Agentの設定も必要です。これなんと私がこの記事書いてよしPublishや！！と思ってPublishしたら動かなかったので確認したらこれも必要だったということらしいです。ユーザー名またはアプリケーション名しようしてくださいとのことなのでGitHubのユーザー名に設定します。</p>\n<ul>\n<li>Payload</li>\n</ul>\n<p>bodyの設定です。。<a href=\"https://docs.github.com/ja/rest/reference/actions#create-a-workflow-dispatch-event\">アクション - GitHub Docs</a>を参考にしましょう。JSON形式で記述します。</p>\n<p>これでContentful側の設定も終わりです。</p>\n<p>一応ワークフローファイル全体も参考までに上げておきます。本当はキャッシュとか効かせるように設定するといいのかな？</p>\n<div class=\"gatsby-highlight\" data-language=\"yml\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-yml line-numbers\"><code class=\"language-yml\"><span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> deploy on github pages\n\n<span class=\"token key atrule\">on</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">push</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">branches</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> main\n  <span class=\"token key atrule\">workflow_dispatch</span><span class=\"token punctuation\">:</span>\n\n<span class=\"token key atrule\">jobs</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">deploy</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Deploy on Github Pages\n    <span class=\"token key atrule\">runs-on</span><span class=\"token punctuation\">:</span> ubuntu<span class=\"token punctuation\">-</span>latest\n    <span class=\"token key atrule\">env</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">CONTENTFUL_HOST</span><span class=\"token punctuation\">:</span> cdn.contentful.com\n      <span class=\"token key atrule\">CONTENTFUL_ACCESS_TOKEN</span><span class=\"token punctuation\">:</span> $<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> secrets.CONTENTFUL_ACCESS_TOKEN <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n      <span class=\"token key atrule\">CONTENTFUL_SPACE_ID</span><span class=\"token punctuation\">:</span> $<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> secrets.CONTENTFUL_SPACE_ID <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n      <span class=\"token key atrule\">GOOGLE_ANALYTICS_GTAG</span><span class=\"token punctuation\">:</span> $<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> secrets.GOOGLE_ANALYTICS_GTAG <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n\n    <span class=\"token key atrule\">steps</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">uses</span><span class=\"token punctuation\">:</span> actions/checkout@v2\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">uses</span><span class=\"token punctuation\">:</span> actions/setup<span class=\"token punctuation\">-</span>node@v2\n        <span class=\"token key atrule\">with</span><span class=\"token punctuation\">:</span>\n          <span class=\"token key atrule\">node-version</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"16.9.1\"</span>\n\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Install packages\n        <span class=\"token key atrule\">run</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">|</span><span class=\"token scalar string\">\n          npm i -g gatsby-cli@3.0.0 yarn@1.22.10\n          yarn install</span>\n\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Build\n        <span class=\"token key atrule\">run</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"gatsby build\"</span>\n\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Deploy on Github Pages\n        <span class=\"token key atrule\">uses</span><span class=\"token punctuation\">:</span> peaceiris/actions<span class=\"token punctuation\">-</span>gh<span class=\"token punctuation\">-</span>pages@v3\n        <span class=\"token key atrule\">with</span><span class=\"token punctuation\">:</span>\n          <span class=\"token key atrule\">github_token</span><span class=\"token punctuation\">:</span> $<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> secrets.GITHUB_TOKEN <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n          <span class=\"token key atrule\">deploy_key</span><span class=\"token punctuation\">:</span> $<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span>secrets.ACTIONS_DEPLOY_KEY<span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n          <span class=\"token key atrule\">external_repository</span><span class=\"token punctuation\">:</span> Furafrafrfr/Furafrafrfr.github.io\n          <span class=\"token key atrule\">publish_branch</span><span class=\"token punctuation\">:</span> main\n          <span class=\"token key atrule\">publish_dir</span><span class=\"token punctuation\">:</span> ./public</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h2>終わりに</h2>\n<p>GitHub Actionsすごい</p>"}}},"blogContext":{"category":["Gatsby.js","Contentful","GitHub Actions","その他","ソフトウェア関係","本"]}},"pageContext":{"slug":"/blog/contentful-github-actions"}},
    "staticQueryHashes": ["28851281","3558571327"]}